# ðŸ“˜ SUB-BAB 13.2: MESIN WAKTU: POINT-IN-TIME RECOVERY (PITR)

## ðŸŽ¯ Tujuan Pembelajaran
Setelah mempelajari sub-bab ini, kamu akan mampu:
1.  Menjelaskan konsep **Point-in-Time Recovery (PITR)** sebagai mekanisme "undo" tingkat lanjut untuk database.
2.  Menganalisis peran vital **Oplog (Operation Log)** dalam memungkinkan pemutaran ulang transaksi secara presisi.
3.  Merancang strategi pemulihan data yang menggabungkan *Snapshot* dan *Oplog Replay* untuk mencapai RPO mendekati nol.

---

## ðŸ”— Context & Hook
Pernahkah kamu mengetik dokumen panjang di Microsoft Word, lalu tiba-tiba salah hapus satu paragraf penting? Untungnya, ada tombol **CTRL+Z (Undo)**. Kamu bisa mundur ke 1 menit yang lalu, tepat sebelum kesalahan terjadi.

Tapi, bagaimana dengan database? Jika kamu melakukan *Snapshot Backup* setiap jam 12 malam, dan kamu melakukan kesalahan fatal di jam 12 siang, tombol "Undo" standar (Restore Backup) hanya akan membawamu kembali ke jam 12 malam kemarin. Data 12 jam kerja hilang!

Di sinilah **Point-in-Time Recovery (PITR)** masuk. Ini adalah fitur "Time Travel" untuk database. Dengan PITR, kamu bisa berkata: *"Saya ingin mengembalikan database ke kondisi persis pada hari ini, pukul 11:59:55, tepat 5 detik sebelum Budi menghapus tabel."*

---

## ðŸ’¡ Analogi: Video Game & Rekaman Replay
1.  **Backup Biasa (Snapshot) = Save Point:**
    Kamu menyimpan game (*Save*) di Level 1. Kamu main terus sampai Level 5, lalu karaktermu mati. Kamu me-load *Save Point* dan terlempar kembali ke Level 1. Semua progres Level 2-5 hilang.
2.  **PITR = Rekaman Replay:**
    Sistem tidak hanya menyimpan *Save Point* di Level 1, tapi juga merekam **video (Log)** dari setiap tombol yang kamu tekan sejak Level 1.
    * Jika kamu mati di Level 5, sistem me-load *Save Point* Level 1, lalu secara otomatis **memutar ulang (Replay)** semua tombol yang kamu tekan dengan kecepatan tinggi sampai ke momen tepat sebelum kamu mati.
    * Hasilnya: Kamu kembali hidup di Level 5!

---

## ðŸ“š Inti Materi

### 1. Apa itu PITR?
Point-in-Time Recovery (PITR) adalah kemampuan untuk memulihkan database ke titik waktu yang sangat spesifik (misalnya, detik ke-X), bukan hanya ke waktu kapan backup terakhir diambil.
* **Tujuan:** Meminimalkan kehilangan data (RPO mendekati nol) di antara jeda waktu backup.

### 2. Mekanisme Kerja: Snapshot + Oplog
Di MongoDB, PITR bekerja dengan menggabungkan dua elemen:
1.  **Base Snapshot:** Backup fisik yang diambil secara berkala (misal: setiap 24 jam).
2.  **Continuous Oplog Archiving:** Proses yang terus-menerus menyalin **Oplog** (Log Operasi yang kita bahas di Bab 7) dari database ke penyimpanan aman (seperti S3).

### 3. Proses Pemulihan (Recovery Process)
Saat kamu meminta PITR ke jam 10:00:
1.  **Restore Snapshot:** Sistem mencari snapshot terdekat *sebelum* jam 10:00 (misal: snapshot jam 00:00). Database dikembalikan ke kondisi jam 00:00.
2.  **Replay Oplog:** Sistem mengambil arsip Oplog dari jam 00:00 hingga 10:00.
3.  **Apply Operations:** Sistem menjalankan ulang setiap operasi (`insert`, `update`, `delete`) yang tercatat di Oplog secara berurutan.
4.  **Stop:** Sistem berhenti tepat di detik terakhir jam 09:59:59. Database kini persis seperti kondisi jam 10:00.

---

## ðŸ“± Contoh Penerapan: E-Commerce Flash Sale
Saat *Flash Sale* 12.12, terjadi *bug* di aplikasi pada pukul 13:05 yang menyebabkan harga semua iPhone menjadi Rp 100 perak. Ribuan transaksi terjadi dalam 5 menit.
1.  **Masalah:** Jika *restore* ke backup jam 12:00, data penjualan normal antara 12:00-13:05 hilang.
2.  **Solusi PITR:**
    * Admin menginstruksikan sistem: *"Restore ke pukul 13:04:59"*.
    * Sistem me-restore backup pagi, lalu me-*replay* semua transaksi valid hingga 1 detik sebelum bug terjadi.
    * Hasil: Transaksi valid terselamatkan, transaksi Rp 100 perak dibatalkan (karena belum terjadi di titik waktu tersebut).

---

## ðŸ“– Mini-Glossary
* **PITR (Point-in-Time Recovery):** Teknik pemulihan data ke stempel waktu (timestamp) tertentu yang presisi.
* **Oplog (Operation Log):** Koleksi internal MongoDB yang mencatat kronologi semua modifikasi data; bahan bakar utama untuk PITR.
* **Oplog Replay:** Proses menerapkan kembali operasi yang tercatat dalam log ke database untuk memajukan status data dari snapshot lama ke waktu yang diinginkan.
* **Continuous Archiving:** Proses menyalin log transaksi secara terus-menerus ke penyimpanan sekunder agar tidak hilang jika server rusak.

---

## ðŸ“ Evaluasi Singkat

### 5 Soal Pilihan Ganda (HOTS)

1.  **Analisis:** Mengapa fitur PITR membutuhkan *Oplog* dan tidak bisa bekerja hanya dengan mengandalkan *Snapshot* harian?
    * a. Karena Snapshot terlalu besar.
    * b. Karena Snapshot hanya memotret keadaan statis pada satu waktu tertentu, sedangkan Oplog merekam *perubahan* yang terjadi detik demi detik di antara dua snapshot.
    * c. Karena Oplog lebih aman.
    * d. Karena Snapshot bisa terkena virus.
    * e. Karena MongoDB tidak mendukung snapshot.

2.  **Urutan:** Dalam proses pemulihan PITR, manakah urutan langkah yang benar?
    * a. Replay Oplog dulu -> Baru Restore Snapshot.
    * b. Restore Snapshot terbaru -> Selesai.
    * c. Restore Snapshot terdekat (masa lalu) -> Replay Oplog dari titik snapshot hingga titik target -> Selesai.
    * d. Hapus database -> Copy file baru.
    * e. Edit Oplog manual -> Restart server.

3.  **Skenario:** Seorang hacker menghapus koleksi `pelanggan` pada pukul 15:00. Kamu memiliki backup snapshot jam 12:00 dan arsip Oplog lengkap. Ke waktu manakah kamu harus melakukan PITR untuk menyelamatkan data maksimal tanpa menyertakan kerusakan oleh hacker?
    * a. 12:00:00
    * b. 15:00:01
    * c. 14:59:59 (Satu detik sebelum kejadian).
    * d. 16:00:00
    * e. Hari berikutnya.

4.  **Konsep:** Apa prasyarat utama agar PITR bisa berfungsi pada MongoDB *Sharded Cluster* (Bab 8)?
    * a. Semua Shard harus dimatikan.
    * b. Harus ada arsip Oplog yang sinkron dari **setiap** Shard dan Config Server agar bisa direplay secara konsisten.
    * c. Tidak perlu prasyarat.
    * d. Hanya perlu backup Config Server.
    * e. Shard Key harus dihapus.

5.  **Perbandingan:** Apa keuntungan utama PITR dibandingkan *Cold Backup* tradisional dalam hal **RPO** (Recovery Point Objective)?
    * a. PITR memungkinkan RPO mendekati nol (kehilangan data minimal), sedangkan Cold Backup memiliki RPO sebesar interval backup (bisa hilang berjam-jam).
    * b. PITR lebih murah.
    * c. PITR lebih cepat waktu restore-nya (RTO).
    * d. Cold Backup tidak bisa di-restore.
    * e. PITR tidak butuh storage.

### Kunci Jawaban
1.  **b** (Snapshot adalah foto, Oplog adalah videonya).
2.  **c** (Snapshot sebagai fondasi dasar, Oplog sebagai "cat" pelapis untuk memutakhirkan).
3.  **c** (Tujuan PITR adalah kembali ke momen terakhir yang "sehat").
4.  **b** (Konsistensi cluster terdistribusi membutuhkan sinkronisasi log semua node).
5.  **a** (Granularitas waktu adalah keunggulan utama PITR).

---

## ðŸš€ Mini Challenge
**Latihan Mesin Waktu:**
Bayangkan kamu punya Snapshot Jam 08.00.
Oplog mencatat 3 kejadian setelahnya:
1.  08.15: Insert User A.
2.  08.30: Update User A (Saldo + 50.000).
3.  08.45: **Error!** Delete User A (Tidak Sengaja).

**Tugas:**
Jika kamu melakukan PITR ke jam **08.40**, bagaimana status User A di database hasil restore?
* *Jawab:* User A **ADA** dan Saldonya sudah bertambah. (Karena sistem me-replay kejadian jam 08.15 dan 08.30, tapi berhenti sebelum kejadian 08.45).

---
*Data sudah aman dari bencana. Sekarang, bagaimana cara tahu kalau database mulai "batuk-batuk" sebelum dia benar-benar sakit? Ketik **"Lanjut"** untuk masuk ke **Sub-Bab 13.3: Radar Sistem: Monitoring & Alerting**.*