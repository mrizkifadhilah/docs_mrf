# ğŸ“˜ SUB-BAB 13.4: TROUBLESHOOTING: MENANGANI SLOW QUERY & CONTENTION

## ğŸ¯ Tujuan Pembelajaran
Setelah mempelajari sub-bab ini, kamu akan mampu:
1.  Menggunakan **Database Profiler** dan **Slow Query Log** untuk mengidentifikasi kueri yang membebani sistem.
2.  Menganalisis hasil `explain()` untuk membedakan antara pencarian efisien (Index Scan) dan pencarian lambat (Collection Scan).
3.  Menjelaskan fenomena **Write Contention** (rebutan kunci) dan dampaknya terhadap kinerja aplikasi konkuren tinggi.

---

## ğŸ”— Context & Hook
Pernahkah kamu mengalami komputer yang tiba-tiba "hang" atau macet total hanya karena membuka satu file Excel yang sangat besar? Padahal spesifikasi komputermu tinggi.

Dalam database, satu **Slow Query** (kueri lambat) yang buruk ibarat file Excel raksasa itu. Ia bisa memonopoli CPU dan Disk, membuat ribuan pengguna lain tidak bisa login. Di sisi lain, jika ribuan pengguna mencoba mengedit satu dokumen yang sama secara bersamaan, mereka akan antre panjang. Ini disebut **Contention**.

Tugasmu sebagai "Dokter Database" adalah menemukan penyumbatan ini dan melancarkan kembali aliran darah sistem.

---

## ğŸ’¡ Analogi: Perpustakaan dan Loket Tiket
1.  **Slow Query (Missing Index) = Mencari Buku Tanpa Katalog:**
    Kamu meminta pustakawan: "Cari buku yang ada kata 'Kancil' di halaman 50."
    Tanpa katalog (Index), pustakawan harus membuka **SEMUA** buku di perpustakaan satu per satu. Ini memakan waktu berjam-jam dan membuat pustakawan tidak bisa melayani orang lain.
2.  **Write Contention = Satu Loket Tiket:**
    Ada 1.000 orang mau beli tiket konser. Tapi hanya ada 1 loket yang buka. Meskipun petugas loketnya cepat, orang tetap harus antre panjang. Dalam database, jika semua orang mencoba mengupdate dokumen yang sama, database mengunci dokumen itu satu per satu, menciptakan antrean (*Lock Wait*).

---

## ğŸ“š Inti Materi

### 1. Deteksi: Database Profiler & Slow Query Log
MongoDB memiliki fitur **Profiler** yang mencatat semua operasi yang memakan waktu lebih lama dari ambang batas tertentu (misal: > 100ms).
* **Langkah 1:** Aktifkan Profiling.
* **Langkah 2:** Cek Log. Cari operasi dengan durasi tinggi.
* **Hasil:** Kamu menemukan kueri tersangka: `db.orders.find({ date: "2023-01-01" })` memakan waktu 5 detik.

### 2. Diagnosa: Explain & Collection Scan
Setelah menemukan tersangka, gunakan perintah `.explain("executionStats")` untuk menginterogasi kueri tersebut (Lihat kembali Bab 5).
* **Tanda Bahaya:** Lihat field `stage`.
    * **COLLSCAN (Collection Scan):** Bahaya! Database membaca seluruh isi koleksi dari awal sampai akhir. Solusi: Buat Index.
    * **IXSCAN (Index Scan):** Bagus! Database menggunakan index.

### 3. Masalah Concurrency: Write Contention
Meskipun MongoDB menggunakan *Document-Level Locking* (kunci per dokumen), masalah tetap bisa terjadi jika:
* **Hot Document:** Ribuan user mengupdate 1 dokumen yang sama (misal: Counter "Total Pengunjung").
* **Solusi:** Pecah dokumen tersebut atau gunakan teknik *sharding* yang lebih baik / *batch update*.

---

## ğŸ“± Contoh Penerapan: Dashboard Lambat
1.  **Keluhan:** CEO komplain dashboard penjualan loadingnya 20 detik.
2.  **Investigasi:** Cek *Slow Query Log*. Ditemukan kueri agregasi `$group` berdasarkan `kategori_produk`.
3.  **Analisis:** Ternyata field `kategori_produk` belum di-index. MongoDB melakukan *COLLSCAN* pada 10 juta data transaksi.
4.  **Tindakan:** `db.transaksi.createIndex({ kategori_produk: 1 })`.
5.  **Hasil:** Waktu loading turun dari 20 detik menjadi 0.5 detik.

---

## ğŸ“– Mini-Glossary
* **Slow Query:** Kueri database yang waktu eksekusinya melebihi ambang batas wajar, menyebabkan degradasi performa.
* **COLLSCAN (Collection Scan):** Strategi pencarian di mana database memindai setiap dokumen dalam koleksi; sangat tidak efisien untuk dataset besar.
* **IXSCAN (Index Scan):** Strategi pencarian yang efisien menggunakan index.
* **Contention:** Persaingan antar-proses untuk memperebutkan sumber daya yang sama (misal: lock pada dokumen), menyebabkan antrean.

---

## ğŸ“ Evaluasi Singkat

### 5 Soal Pilihan Ganda (HOTS)

1.  **Diagnosis:** Kamu menjalankan `explain()` pada sebuah kueri lambat dan melihat `totalDocsExamined: 1000000` tetapi `nReturned: 5`. Apa kesimpulanmu?
    * a. Kueri sangat efisien.
    * b. Terjadi *Collection Scan* parah; database memeriksa 1 juta dokumen hanya untuk menemukan 5 hasil. Perlu Index.
    * c. Database rusak.
    * d. Hasilnya terlalu sedikit.
    * e. Disk penuh.

2.  **Analisis:** Mengapa *Write Contention* sering terjadi pada aplikasi yang memiliki fitur "Global Counter" (satu dokumen yang di-*increment* oleh semua user)?
    * a. Karena MongoDB tidak bisa berhitung.
    * b. Karena semua request harus mengantre untuk mendapatkan *Lock* (kunci) pada satu dokumen tunggal tersebut secara bergantian.
    * c. Karena indexnya salah.
    * d. Karena RAM kurang.
    * e. Karena jaringannya lambat.

3.  **Strategi:** Apa langkah pertama yang paling logis saat kamu menerima peringatan "CPU Database 99%"?
    * a. Restart server langsung.
    * b. Upgrade server ke yang lebih mahal.
    * c. Cek *Current Operations* (`db.currentOp()`) atau *Slow Log* untuk melihat apakah ada kueri liar yang sedang berjalan.
    * d. Hapus data lama.
    * e. Matikan aplikasi.

4.  **Teknis:** Fitur apa di MongoDB yang berfungsi seperti "Kotak Hitam Pesawat" untuk merekam kueri-kueri bermasalah?
    * a. Journaling.
    * b. Database Profiler.
    * c. Oplog.
    * d. Replication.
    * e. Sharding.

5.  **Konsep:** Jika kueri sudah menggunakan Index (IXSCAN) tapi masih lambat, apa kemungkinan penyebabnya?
    * a. Index yang digunakan tidak selektif (misal: index pada field 'jenis_kelamin' di data penduduk), sehingga masih memindai 50% data.
    * b. Indexnya rusak.
    * c. MongoDB sedang tidur.
    * d. Data terlalu sedikit.
    * e. Salah ketik kueri.

### Kunci Jawaban
1.  **b** (Rasio pemeriksaan vs hasil yang buruk adalah tanda utama *missing index*).
2.  **b** (*Serialization* akses pada satu sumber daya adalah *bottleneck* konkurensi).
3.  **c** (Diagnosa dulu sebelum tindakan drastis; seringkali hanya 1 kueri buruk penyebabnya).
4.  **b** (Alat diagnosa kinerja utama).
5.  **a** (Kualitas index juga penting, bukan hanya keberadaannya).

---

## ğŸš€ Mini Challenge
**Detektif Kueri:**
1.  Bayangkan kamu punya koleksi `buku` dengan 1 juta dokumen.
2.  Kueri: `db.buku.find({ tahun_terbit: 2020, penulis: "Tere Liye" })`.
3.  Tanpa index, berapa dokumen yang diperiksa? (Jawab: 1 Juta / Semua).
4.  Jika kamu buat index `{ penulis: 1 }`, dan ada 50 buku Tere Liye, berapa yang diperiksa? (Jawab: Sekitar 50).
5.  Bayangkan penghematan energinya!

---
*Bab 13 Selesai! Kamu sekarang adalah penjaga gawang yang tangguh bagi kesehatan databasemu. Ketik **"Lanjut"** untuk masuk ke **Bagian Penutup (Outro)**.*